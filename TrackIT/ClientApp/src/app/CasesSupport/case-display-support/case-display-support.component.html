<h1 id="tableLabel">Case</h1>

<p *ngIf="!case"><em>Loading...case details</em></p>

<div *ngIf="case">

  <br />
  <a class="" [routerLink]="['/cases-list-support']">Back</a>
  <br /><br />
  <hr />
  <div>
    <div class="row">
      <div class="col">Case</div>
      <div class="col">Status</div>
    </div>
    <div class="row">
      <div class="col"><b>{{ case.id }}</b></div>
      <div class="col"><b>{{ casesService.statusNames[case.status-1] }}</b></div>
    </div>
    <br />
    <div class="row">
      <div class="col">Software</div>
      <div class="col">Date/Time Opened</div>
    </div>
    <div class="row">
      <div class="col"><b>{{ case.software.name }}</b></div>
      <div class="col"><b>{{ case.dateOpened | date: 'dd-MMM-yy HH:mm' }}</b></div>
    </div>
    <br />
    <div class="row">
      <div class="col">Type</div>
      <div class="col">Created by</div>
    </div>
    <div class="row">
      <div class="col"><b>{{ casesService.types[case.type-1] }}</b></div>
      <div class="col"><b>{{ case.userInfo.firstName }} {{ case.userInfo.lastName }}</b></div>
    </div>
    <br />
    <div class="row">
      <div class="col">Urgency</div>
      <div class="col">Contact</div>
    </div>
    <div class="row">
      <div class="col"><b>{{ casesService.urgencyLevels[case.urgencyLevel-1] }}</b></div>
      <div class="col"><b>{{ case.contactInfo.firstName }} {{ case.contactInfo.lastName }} - {{ case.contactInfo.email }}</b></div>
    </div>
    <br />

    <!--Bug/Feature only-->
    <div *ngIf="(case.type == 1 || case.type == 4)">
      <div class="row">
        <div class="col">Deadline Date</div>
        <div class="col" *ngIf="(isUserDeveloper || isUserContact)">Date Fix awaiting approval</div>
      </div>
      <div class="row">
        <div *ngIf="case.deadline || !(userRole | async)?.includes('manager')" class="col"><b>{{ (case.deadline | date: 'dd-MMM-yy') || "Not yet set" }}</b></div>
        <div *ngIf="(userRole | async)?.includes('manager') && !case.deadline" class="col">
          <form #setDeadlineForm="ngForm" (ngSubmit)="onSubmitDeadline(setDeadlineForm)">
            <div class="input-group">
              <input type="date" class="form-control" id="deadline"
                     name="deadline" placeholder="Deadline" required
                     [(ngModel)]="deadlineModel.deadline" #deadline="ngModel" />
              <div class="input-group-prepend">
                <button [disabled]="!setDeadlineForm.valid" type="submit" class="btn btn-sm btn-primary">OK</button>
              </div>
            </div>
          </form>
        </div>
        <div *ngIf="!case.dateAwaitApproval && (isUserDeveloper || isUserContact)" class="col"><button (click)="submitFix()" class="btn btn-sm btn-outline-primary">Request Fix Approval</button></div>
        <div *ngIf="case.dateAwaitApproval && (isUserDeveloper || isUserContact)" class="col"><b>{{ (case.dateAwaitApproval | date: 'dd-MMM-yy HH:mm') }}</b></div>
      </div>
    </div>
    <br />

    <div *ngIf="(case.type == 1 || case.type == 4) && (isUserDeveloper || isUserContact)">
      <div class="row">
        <div class="col">Date fix approved</div>
        <div class="col">Date Fix applied</div>
      </div>
      <div class="row">
        <div *ngIf="(userRole | async)?.includes('manager') && case.dateAwaitApproval && !case.dateApproved" class="col"><button (click)="submitFixApproval()" class="btn btn-sm btn-outline-primary">Approve Fix</button></div>
        <div *ngIf="case.dateApproved || !case.dateAwaitApproval" class="col"><b>{{ (case.dateApproved | date: 'dd-MMM-yy HH:mm') || "N/A" }}</b></div>
        <div *ngIf="case.dateApproved && !case.dateApplied" class="col"><button (click)="submitFixApplied()" class="btn btn-sm btn-outline-primary">Applied Fix</button></div>
        <div *ngIf="case.dateApplied || !case.dateApproved" class="col"><b>{{ (case.dateApplied | date: 'dd-MMM-yy HH:mm') || "N/A" }}</b></div>
      </div>
      <br />
    </div>
    <!--Bug/Feature only-->

    <div class="row">
      <div class="col">Date Case Assigned</div>
      <div class="col">Date Completed</div>
    </div>
    <div class="row">
      <div class="col"><b>{{ (case.dateAssigned | date: 'dd-MMM-yy HH:mm') || "Not set yet" }}</b></div>
      <div class="col"><b>{{ (case.dateCompleted | date: 'dd-MMM-yy HH:mm') || "Not completed" }}</b></div>
    </div>
    <br />

    <div class="row">
      <div *ngIf="isUserDeveloper || isUserContact" class="col mouseHover" (click)="showEstHoursForm()">Estimated hours required</div>
      <div *ngIf="!isUserDeveloper && !isUserContact" class="col">Estimated hours required</div>
      <div *ngIf="isUserDeveloper || isUserContact" class="col mouseHover" (click)="showHoursSpentForm()">Hours spent</div>
      <div *ngIf="!isUserDeveloper && !isUserContact" class="col">Hours spent</div>
    </div>
    <div class="row">

      <div *ngIf="!estHoursEntry" class="col"><b>{{ case.estimatedTimeHours || "Not set yet"}}</b></div>
      <div *ngIf="estHoursEntry" class="col">
        <form #estHoursForm="ngForm" (ngSubmit)="onSubmitEstHours(estHoursForm)">
          <div class="input-group col-9 col-sm-4">
            <input type="number" class="form-control" id="estHours"
                   name="estHours" placeholder="Hours" min="0" max="999" required
                   [(ngModel)]="estHoursModel.estimatedTimeHours" #estimatedTimeHours="ngModel" />
            <div class="input-group-prepend">
              <button [disabled]="!estHoursForm.valid" type="submit" class="btn btn-sm btn-primary">OK</button>
            </div>
          </div>
        </form>
      </div>

      <div *ngIf="!hoursSpentEntry" class="col"><b>{{ case.timeSpentHours || "Not set yet" }}</b></div>
      <div *ngIf="hoursSpentEntry" class="col">
        <form #hoursSpentForm="ngForm" (ngSubmit)="onSubmitHoursSpent(hoursSpentForm)">
          <div class="input-group col-9 col-sm-4">
            <input type="number" class="form-control" id="hoursSpent"
                   name="hoursSpent" placeholder="Hours" min="0" max="999" required
                   [(ngModel)]="hoursSpentModel.timeSpentHours" #timeSpentHours="ngModel" />
            <div class="input-group-prepend">
              <button [disabled]="!hoursSpentForm.valid" type="submit" class="btn btn-sm btn-primary">OK</button>
            </div>
          </div>
        </form>
      </div>
    </div>


  </div>









  <br />
  <hr />

  <div>Subject</div>
  <div><b>{{ case.title }}</b></div>
  <br />
  <div>Description</div>
  <div><b>{{ case.description }}</b></div>
  <br />

  <div class="row">
    <div *ngIf="(isUserDeveloper || isUserContact) && (case.type == 2 || case.type == 3)" class="col">
      <form #completeForm="ngForm" (ngSubmit)="onSubmitComplete(completeForm)">
        <button *ngIf="case.status != 7" type="submit" class="btn btn-primary">Consider Complete</button>
        <button *ngIf="case.status == 7" type="submit" class="btn btn-primary">Re-Open Case</button>
      </form>
    </div>
    <div *ngIf="isUserDeveloper || isUserContact" class="col">
      <form #awaitCustForm="ngForm" (ngSubmit)="onSubmitAwaitCust(awaitCustForm)">
        <button *ngIf="case.status == 2" type="submit" class="btn btn-primary">Set as Await Customer</button>
        <button *ngIf="case.status == 3" type="submit" class="btn btn-primary">Set as Await Us</button>
      </form>
    </div>
  </div>
  <br />
  <div class="row">
    <div *ngIf="(isUserDeveloper || isUserContact) && (case.type == 1 || case.type == 4)" class="col">
      <form #onHoldForm="ngForm" (ngSubmit)="onSubmitOnHold(onHoldForm)">
        <button *ngIf="case.status <= 3" type="submit" class="btn btn-primary">Put case on hold</button>
        <button *ngIf="case.status == 4" type="submit" class="btn btn-primary">Release from hold</button>
      </form>
    </div>
  </div>


  <br />

  <form #messageForm="ngForm" (ngSubmit)="onSubmitMessage(messageForm)">
    <div class="form-group">
      <label for="inputMessage">New message</label>
      <textarea type="text" class="form-control" id="comment" rows="3"
                [ngClass]="(comment.invalid && (comment.dirty || comment.touched))?'text-danger is-invalid':''"
                name="comment" placeholder="Enter Message" minlength="2" required
                [(ngModel)]="messageModel.comment" #comment="ngModel">
        </textarea>
      <!--<small *ngIf="comment.errors?.required && (comment.dirty || comment.touched)" class="text-danger">Message is required. </small>-->
      <small *ngIf="comment.errors?.minlength" class="text-danger">Message must be at least 2 characters long.</small>
    </div>

    <button [disabled]="!messageForm.valid" type="submit" class="btn btn-primary">Submit Message</button>
  </form>


  <div *ngIf="messages">
    <br />
    <div *ngFor="let message of messages">
      <p>{{message.timeStamp | date: 'dd-MMM-yy HH:mm' }} : {{ message.comment }}</p> <!--need to restrict to say 30 chars and add a button (downward arrow) to show message in full-->
    </div> <!-- write a pipe to convert isEmployee true into ">" and false into "<" -->
    <br />
  </div>

  <hr />


  <div>Contact Assigned</div>
  <div *ngIf="!case.contactId"><b>No contact</b></div>
  <div *ngIf="!assignStaffFlag && case.contactId"><b>{{ case.contactInfo.firstName }} {{ case.contactInfo.lastName }}</b></div>
  <div *ngIf="assignStaffFlag && case.contactId" class="text-info"><i>{{ case.contactInfo.firstName }} {{ case.contactInfo.lastName }} (Not submitted yet)</i></div>
  <br />
  <div>Developers Assigned</div>
  <div *ngIf="assignedStaff.length==0 && !assignStaffFlag"><b>No developers</b></div>
  <div *ngIf="assignedStaff.length==0 && assignStaffFlag" class="text-info">No developers</div>

  <div>
    <div *ngFor="let employee of assignedStaffNames">
      <div *ngIf="!assignStaffFlag"><b>{{ employee }}</b></div>
      <div *ngIf="assignStaffFlag" class="text-info"><i>{{ employee }} (Not submitted yet)</i></div>
    </div>
  </div>

  <br />
  <div *ngIf="(userRole | async)?.includes('manager') && !assignStaffFlag">
    <button *ngIf="!case.dateAssigned" (click)="showAssignEmployeeSection(case.id)" class="btn btn-primary">Assign staff</button>
    <button *ngIf="case.dateAssigned" (click)="showAssignEmployeeSection(case.id)" class="btn btn-primary">Adjust assigned staff</button>
  </div>








  <div *ngIf="assignStaffFlag">
    <p *ngIf="!users"><em>Loading...</em></p>
    <div *ngIf="users">
      <form #assignForm="ngForm" (ngSubmit)="submitAssignedStaff(assignForm)">
        <button type="submit" class="btn btn-info">Submit staff</button>
      </form>
      <br />
      <table class='table table-striped' aria-labelledby="tableLabel">
        <thead>
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th>Assigned</th>
            <th></th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users">
            <td>{{ user.firstName }} {{ user.lastName }}</td>
            <td *ngIf="user.userId == case.contactId">Contact</td>
            <td *ngIf="user.userId != case.contactId"></td>
            <td *ngIf="assignedStaff.includes(user.userId)">Assigned</td>
            <td *ngIf="!assignedStaff.includes(user.userId)"></td>
            <td *ngIf="!assignedStaff.includes(user.userId)"><button (click)="assignEmployee(user.userId)" class="btn btn-sm btn-outline-info">Assign</button></td>
            <td *ngIf="assignedStaff.includes(user.userId)"><button (click)="assignEmployee(user.userId)" class="btn btn-sm btn-outline-info">Unassign</button></td>
            <td><button (click)="assignContact(user.userId, user.firstName, user.lastName, user.email, user.userName)" class="btn btn-sm btn-outline-info">Set Contact</button></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <br />
  <hr />






  <p>Deadline: {{ case.deadline }}</p> <!--update by any managers only-->

</div>
